services:
  # =============================================================================
  # BASE IMAGE SERVICE
  # =============================================================================
  
  ghost-base:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.base
      target: dependencies
      cache_from:
        - ghost-base:dependencies
    image: ghost-base:dependencies
    command: /bin/true
    networks:
      - ghost-network

  # =============================================================================
  # INFRASTRUCTURE SERVICES
  # =============================================================================

  redis:
    image: redis:7-alpine
    container_name: ghost-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --appendfsync everysec
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ghost-network
    restart: unless-stopped

  # =============================================================================
  # MCP SERVERS (Tool providers)
  # =============================================================================

  mcp-filesystem:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.mcp
    container_name: ghost-mcp-filesystem
    ports:
      - "${MCP_FILESYSTEM_PORT:-8080}:8080"
    environment:
      # MCP Configuration
      MCP_SERVER_TYPE: filesystem
      MCP_TRANSPORT: http
      MCP_PORT: 8080
      MCP_ALLOWED_DIRECTORIES: ${MCP_ALLOWED_DIRECTORIES:-/app/data}
      MCP_READONLY: ${MCP_READONLY:-false}
      
      # Claude API (for MCP server that needs it)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
    volumes:
      - ./common:/app/common:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-data:/app/data
      - ghost-logs:/app/logs
    depends_on:
      ghost-base:
        condition: service_completed_successfully
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  mcp-agents:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.mcp
    container_name: ghost-mcp-agents
    ports:
      - "${MCP_AGENTS_PORT:-8081}:8081"
    environment:
      # MCP Configuration
      MCP_SERVER_TYPE: agents
      MCP_TRANSPORT: http
      MCP_PORT: 8081
      
      # Claude API (for MCP server that needs it)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
    depends_on:
      ghost-base:
        condition: service_completed_successfully
    networks:
      - ghost-network
    restart: unless-stopped
    command: ["/app/.venv/bin/python", "-m", "mcp_server.agents"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # =============================================================================
  # ORCHESTRATOR
  # =============================================================================

  orchestrator:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.orchestrator
    container_name: ghost-orchestrator
    ports:
      # Orchestrator runs its own A2A server on this port
      - "${ORCHESTRATOR_A2A_PORT:-8765}:8765"
    environment:
      # Agent Configuration
      AGENT_ID: orchestrator
      AGENT_ROLE: orchestrator
      A2A_PORT: 8765
      
      # Redis for service discovery
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      
      # Claude API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Orchestrator Settings
      MAX_WORKERS: ${MAX_WORKERS:-10}
      WORKER_TIMEOUT: ${WORKER_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # =============================================================================
  # WORKER AGENTS (Scale these as needed)
  # =============================================================================

  worker-1:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-1
    environment:
      # Worker Configuration
      AGENT_ID: ${AGENT_ID:-worker-1}      # âœ… Alternative
      WORKER_CAPABILITIES: ${WORKER_1_CAPABILITIES:-llm_inference,data_processing,analysis}
      # Claude API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Worker Settings
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  worker-2:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-2
    environment:
      # Worker Configuration
      AGENT_ID: ${AGENT_ID:-worker-2}
      WORKER_CAPABILITIES: ${WORKER_2_CAPABILITIES:-llm_inference,data_processing,analysis}
      # Claude API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Worker Settings
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  worker-3:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-3
    environment:
      # Worker Configuration
      AGENT_ID: ${AGENT_ID:-worker-3}
      WORKER_CAPABILITIES: ${WORKER_3_CAPABILITIES:-llm_inference,data_processing,analysis}
      # Claude API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      
      # Worker Settings
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  # Application data (logs, cache, temporary files)
  ghost-data:
    driver: local

  # Logs from all services
  ghost-logs:
    driver: local

  # Redis persistence
  redis-data:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  ghost-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16