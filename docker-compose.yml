# Ghost Swarm Agent Mesh Docker Compose
# Implements complete Agent Mesh architecture with AgentGateway

services:
  # ===========================================================================
  # BASE IMAGE
  # ===========================================================================
  
  ghost-base:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.base
      target: dependencies
    image: ghost-base:dependencies
    command: /bin/true
    networks:
      - ghost-network

  # ===========================================================================
  # INFRASTRUCTURE
  # ===========================================================================

  redis:
    image: redis:7-alpine
    container_name: ghost-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ghost-network
    restart: unless-stopped

  # ===========================================================================
  # LAYER 1: AGENT MESH (AgentGateway)
  # ===========================================================================
  # Unified entry point for:
  # - LLM routing and caching
  # - MCP tool federation
  # - A2A agent mesh
  
 
  agentgateway:
    image: ghcr.io/agentgateway/agentgateway:latest
    container_name: ghost-agentgateway
    ports:
      - "${AGENTGATEWAY_PORT:-3000}:3000"        # Main gateway
      - "${AGENTGATEWAY_UI_PORT:-15000}:15000"   # Built-in UI
      - "15020:15020"                             # Stats/Health endpoint
    volumes:
      - ./agentgateway-config.yaml:/app/config.yaml:ro
      - ./common:/app/common:ro                   # For MCP servers
      - ./mcp_server:/app/mcp_server:ro          # For MCP servers
      - ./ghosts:/app/ghosts:ro                   # For agents MCP
      - ghost-data:/app/data                      # MCP filesystem access
      - gateway-logs:/var/log/agentgateway
    command: ["-f", "/app/config.yaml"]
    environment:
      # Logging
      RUST_LOG: ${RUST_LOG:-info}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      
      # For MCP servers running via stdio
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
    depends_on:
      redis:
        condition: service_healthy
      slm-server:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      # AgentGateway exposes stats/readiness on port 15020
      # Using TCP check since curl is not available in the agentgateway image
      # test: ["CMD-SHELL", "timeout 5 sh -c '</dev/tcp/127.0.0.1/15020' || exit 1"]
      # interval: 30s
      # timeout: 10s
      # start_period: 30s
      # retries: 3
      disable: true

  # ===========================================================================
  # SLM SERVER (Local Inference)
  # ===========================================================================
  
  slm-server:
    image: ghcr.io/ggerganov/llama.cpp:server
    container_name: ghost-slm-server
    ports:
      - "${SLM_PORT:-8080}:8080"
    volumes:
      - ./models:/models:ro
      - slm-cache:/cache
    command: 
      - "-m"
      - "/models/Phi-3-mini-4k-instruct-q4.gguf"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8080"
      - "-c"
      - "4096"
      - "-t"
      - "8"
      - "--metrics"
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

  # ===========================================================================
  # LAYER 2: AGENTS
  # ===========================================================================

  orchestrator:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.orchestrator
    container_name: ghost-orchestrator
    ports:
      - "${ORCHESTRATOR_A2A_PORT:-8765}:8765"
    environment:
      # Agent config
      AGENT_ID: orchestrator
      AGENT_ROLE: orchestrator
      A2A_PORT: 8765
      
      # Agent Mesh URLs
      AGENTGATEWAY_URL: http://agentgateway:3000
      AGENTGATEWAY_MCP_URL: http://agentgateway:3000
      AGENTGATEWAY_A2A_URL: http://agentgateway:3000
      
      # Direct LLM access (for now, later via gateway)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-claude-sonnet-4-5-20250929}
      
      # SLM via gateway
      SLM_ENDPOINT: http://agentgateway:3000/v1
      SLM_MODEL: ${SLM_MODEL:-phi-3-mini}
      
      # TaskMaster
      SIMPLE_THRESHOLD: ${SIMPLE_THRESHOLD:-0.3}
      COMPLEX_THRESHOLD: ${COMPLEX_THRESHOLD:-0.7}
      
      # Infrastructure
      REDIS_URL: redis://redis:6379
      MAX_WORKERS: ${MAX_WORKERS:-10}
      WORKER_TIMEOUT: ${WORKER_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      agentgateway:
        condition: service_started
      slm-server:
        condition: service_healthy
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  worker-1:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-1
    ports:
      - "${WORKER_1_A2A_PORT:-8766}:8766"
    environment:
      AGENT_ID: worker-1
      AGENT_ROLE: worker
      A2A_PORT: 8766
      WORKER_CAPABILITIES: ${WORKER_1_CAPABILITIES:-llm_inference,data_processing,analysis}
      
      # Agent Mesh
      AGENTGATEWAY_URL: http://agentgateway:3000
      AGENTGATEWAY_MCP_URL: http://agentgateway:3000
      AGENTGATEWAY_A2A_URL: http://agentgateway:3000
      
      # LLM
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-claude-sonnet-4-5-20250929}
      SLM_ENDPOINT: http://agentgateway:3000/v1
      SLM_MODEL: ${SLM_MODEL:-phi-3-mini}
      
      # Infrastructure
      REDIS_URL: redis://redis:6379
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
      agentgateway:
        condition: service_started
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  worker-2:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-2
    ports:
      - "${WORKER_2_A2A_PORT:-8767}:8766"
    environment:
      AGENT_ID: worker-2
      AGENT_ROLE: worker
      A2A_PORT: 8766
      WORKER_CAPABILITIES: ${WORKER_2_CAPABILITIES:-llm_inference,data_processing,analysis}
      AGENTGATEWAY_URL: http://agentgateway:3000
      AGENTGATEWAY_MCP_URL: http://agentgateway:3000
      AGENTGATEWAY_A2A_URL: http://agentgateway:3000
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-claude-sonnet-4-5-20250929}
      SLM_ENDPOINT: http://agentgateway:3000/v1
      SLM_MODEL: ${SLM_MODEL:-phi-3-mini}
      REDIS_URL: redis://redis:6379
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
      agentgateway:
        condition: service_started
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  worker-3:
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile.worker
    container_name: ghost-worker-3
    ports:
      - "${WORKER_3_A2A_PORT:-8768}:8766"
    environment:
      AGENT_ID: worker-3
      AGENT_ROLE: worker
      A2A_PORT: 8766
      WORKER_CAPABILITIES: ${WORKER_3_CAPABILITIES:-llm_inference,data_processing,analysis}
      AGENTGATEWAY_URL: http://agentgateway:3000
      AGENTGATEWAY_MCP_URL: http://agentgateway:3000
      AGENTGATEWAY_A2A_URL: http://agentgateway:3000
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-claude-sonnet-4-5-20250929}
      SLM_ENDPOINT: http://agentgateway:3000/v1
      SLM_MODEL: ${SLM_MODEL:-phi-3-mini}
      REDIS_URL: redis://redis:6379
      MAX_LOAD: ${WORKER_MAX_LOAD:-5}
      TASK_TIMEOUT: ${TASK_TIMEOUT:-300}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      - ./common:/app/common:ro
      - ./ghosts:/app/ghosts:ro
      - ./mcp_server:/app/mcp_server:ro
      - ghost-logs:/app/logs
      - ghost-data:/app/data
    depends_on:
      ghost-base:
        condition: service_completed_successfully
      orchestrator:
        condition: service_healthy
      agentgateway:
        condition: service_started
    networks:
      - ghost-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  ghost-data:
  ghost-logs:
  redis-data:
  slm-cache:
  gateway-logs:

networks:
  ghost-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16